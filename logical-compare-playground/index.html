<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Logical compare playground</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.min.css" />
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="card-body">
                <h1 class="card-title">Logical Compare Playground</h1>
                An editor for <a href="https://github.com/fendy3002/QzNode/tree/master/packages/logicalCompare#readme">Logical
                    compare</a>
                structures made out of <a href="https://developers.google.com/blockly/">Blockly</a>.<br />
                Inspired by <a href="https://github.com/ens-lg4/MenulyJSON">MenulyJSON</a>.
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 text-center">
                        Try to construct the logic below, using Blockly, JSON or YAML.
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 text-center">
                        <button class="btn btn-primary" id="btnBlockly">Blockly</button>
                        <button class="btn btn-primary" id="btnJson">JSON</button>
                        <button class="btn btn-primary" id="btnYaml">YAML</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row" id="divBlockly">
                    <div class="col-12">
                        <div id="blocklyDiv" style="height:600px;"></div>

                        <xml id="toolbox" style="display: none">
                            <category name="Misc" colour="290">
                                <block type="start"></block>
                            </category>
                            <category name="Properties" colour="20">
                                <block type="s_prop"></block>
                                <block type="number"></block>
                                <block type="string"></block>
                                <block type="s_boolean"></block>
                                <block type="boolean"></block>
                                <block type="s_date"></block>
                            </category>
                            <category name="Logic" colour="210">
                                <block type="s_compare"></block>
                                <block type="s_and"></block>
                                <block type="s_or"></block>
                                <block type="s_between"></block>
                                <block type="s_between_ex"></block>
                            </category>
                        </xml>
                    </div>
                </div>
                <div class="row" id="divParsed">
                    <div class="col-12">
                        <textarea id="parsed_area" class="form-control" rows="20"></textarea>
                    </div>
                </div>
                <div class="row">
                    <div style="height: 120px"></div>
                </div>
            </div>
        </div>

    </div>
    <script type="text/javascript" src="blockly_compressed.js"></script>

    <!-- blocks to build JSON structures from: -->
    <script type="text/javascript" src="logical_compare_blocks.js"></script>

    <!-- transforming a blockly diagram into a JSON string: -->
    <script type="text/javascript" src="logical_compare_codegen.js"></script>

    <!-- building a blockly diagram from a JSON string: -->
    <script type="text/javascript" src="logical_compare_parsetext.js"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.13.1/js-yaml.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/mode/javascript/javascript.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/mode/yaml/yaml.min.js"></script>

    <script>
        let state = {
            currentFormat: "YAML",
            editor: null
        };

        document.getElementById("btnBlockly").onclick = () => changeFormat("BLOCKLY");
        document.getElementById("btnJson").onclick = () => changeFormat("JSON");
        document.getElementById("btnYaml").onclick = () => changeFormat("YAML");

        let init = (Blockly) => {
            Blockly.inject(document.getElementById('blocklyDiv'), {
                //rtl: true,
                toolbox: document.getElementById('toolbox'),
                //media: 'media/',    // to avoid reaching to the web for icons
                sounds: false,
                collapse: true, comments: true, disable: false, scrollbars: true, trashcan: true // those ones are automatically true when there are categories
            });
            state.editor = CodeMirror.fromTextArea(document.getElementById("parsed_area"), {
                lineNumbers: true,
                mode: "yaml"
            });

            let yamlText = `$and:
  - $or:
      - $compare:
          - $date: null
            $prop: birth_date
          - lt
          - $date: '2010-01-01'
      - $compare:
          - $prop: first_name
          - starts_with
          - June
  - $between:
      - 0
      - $prop: total_price
      - 1000`;

            state.editor.setValue(yamlText);
            changeFormat("BLOCKLY");
        };
        function changeFormat(newFormat) {
            let oldFormat = state.currentFormat;
            let currentValue = null;
            let parsedText = state.editor.getValue();
            try {
                if (oldFormat == "BLOCKLY") {
                    currentValue = JSON.parse(Blockly.logical_compare.toText(Blockly.getMainWorkspace()));
                }
                else if (oldFormat == "YAML") {
                    currentValue = jsyaml.safeLoad(parsedText);
                }
                else if (oldFormat == "JSON") {
                    currentValue = JSON.parse(parsedText);
                }

                if (newFormat == "BLOCKLY") {
                    document.getElementById("divParsed").style.display = "none";
                    document.getElementById("divBlockly").style.display = "block";
                    Blockly.logical_compare.parseText(JSON.stringify(currentValue), Blockly.getMainWorkspace());
                }
                else if (newFormat == "YAML") {
                    document.getElementById("divParsed").style.display = "block";
                    document.getElementById("divBlockly").style.display = "none";
                    state.editor.setValue(jsyaml.dump(currentValue, 2));
                    state.editor.setOption("mode", "yaml");
                }
                else if (newFormat == "JSON") {
                    document.getElementById("divParsed").style.display = "block";
                    document.getElementById("divBlockly").style.display = "none";
                    state.editor.setValue(JSON.stringify(currentValue, null, 2));
                    state.editor.setOption("mode", "javascript");
                }

                state.currentFormat = newFormat;
            } catch (ex) {
                if (ex.message == "Element is not recognized") {
                    alert(ex.message);
                    document.getElementById("divParsed").style.display = "block";
                    document.getElementById("divBlockly").style.display = "none";
                }
                else {
                    alert("Current value is wrong");
                }
            }
        };

        initBlocks(Blockly);
        initCodegen(Blockly);
        initParseText(Blockly);
        init(Blockly);
    </script>
</body>

</html>