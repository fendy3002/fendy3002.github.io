<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Logical compare playground</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.min.css" />
</head>

<body>
    <div class="container">
        <div class="row">
            <h1>
                An editor for <a
                    href="https://github.com/fendy3002/QzNode/tree/master/packages/logicalCompare#readme">Logical
                    compare</a>
                structures made out of <a href="https://developers.google.com/blockly/">Blockly</a>.<br />
                Inspired by <a href="https://github.com/ens-lg4/MenulyJSON">MenulyJSON</a>.
            </h1>
        </div>
        <div class="row">
            <div class="col-12">
                <div id="blocklyDiv" style="height:600px;"></div>

                <xml id="toolbox" style="display: none">
                    <category name="Misc" colour="290">
                        <block type="start"></block>
                    </category>
                    <category name="Properties" colour="20">
                        <block type="s_prop"></block>
                        <block type="number"></block>
                        <block type="string"></block>
                        <block type="s_boolean"></block>
                        <block type="boolean"></block>
                        <block type="s_date"></block>
                    </category>
                    <category name="Logic" colour="210">
                        <block type="s_compare"></block>
                        <block type="s_and"></block>
                        <block type="s_or"></block>
                        <block type="s_between"></block>
                        <block type="s_between_ex"></block>
                    </category>
                </xml>
            </div>
        </div>
        <div class="row">
            <div class="col-12 text-center">
                <button class="btn btn-primary" id="btnGenerate"><i class="fa fa-arrow-down"></i> Generate</button>
                <button class="btn btn-primary" id="btnInterpret"><i class="fa fa-arrow-up"></i> Interpret</button>
                <button class="btn btn-primary" id="btnConvert"><i class="fa fa-sync"></i> Convert</button>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <textarea id=parsed_area class="form-control" rows="20"></textarea>
            </div>
        </div>
        <div class="row">
            <div style="height: 120px"></div>
        </div>
    </div>
    <script type="text/javascript" src="blockly_compressed.js"></script>

    <!-- blocks to build JSON structures from: -->
    <script type="text/javascript" src="logical_compare_blocks.js"></script>

    <!-- transforming a blockly diagram into a JSON string: -->
    <script type="text/javascript" src="logical_compare_codegen.js"></script>

    <!-- building a blockly diagram from a JSON string: -->
    <script type="text/javascript" src="logical_compare_parsetext.js"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.13.1/js-yaml.min.js"></script>
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.min.js"></script>
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/mode/javascript/javascript.min.js"></script>
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/mode/yaml/yaml.min.js"></script>

    <script>
        let state = {
            currentFormat: "YAML",
            editor: null
        };

        document.getElementById("btnGenerate").onclick = toText;
        document.getElementById("btnInterpret").onclick = parseText;
        document.getElementById("btnConvert").onclick = convertFormat;

        let init = (Blockly) => {
            Blockly.inject(document.getElementById('blocklyDiv'), {
                //rtl: true,
                toolbox: document.getElementById('toolbox'),
                //media: 'media/',    // to avoid reaching to the web for icons
                sounds: false,
                collapse: true, comments: true, disable: false, scrollbars: true, trashcan: true // those ones are automatically true when there are categories
            });
            state.editor = CodeMirror.fromTextArea(document.getElementById("parsed_area"), {
                lineNumbers: true,
                mode: "yaml"
            });

            let yamlText = `$and:
  - $or:
      - $compare:
          - $date: null
            $prop: birth_date
          - lt
          - $date: '2010-01-01'
      - $compare:
          - $prop: first_name
          - starts_with
          - June
  - $between:
      - 0
      - $prop: total_price
      - 1000`;

            state.editor.setValue(yamlText);
            parseText();
        };
        function toText() {
            let textResult = Blockly.logical_compare.toText(Blockly.getMainWorkspace());
            if (state.currentFormat == "YAML") {
                textResult = YAML.dump(JSON.parse(textResult));
            }
            state.editor.setValue(textResult);
        };
        function parseText() {
            let parsedText = state.editor.getValue();
            if (state.currentFormat == "YAML") {
                parsedText = JSON.stringify(jsyaml.safeLoad(parsedText), null, 2);
            }
            Blockly.logical_compare.parseText(parsedText, Blockly.getMainWorkspace());
        };
        function convertFormat() {
            let currentText = state.editor.getValue();
            let nextText = "";
            if (state.currentFormat == "YAML") {
                nextText = JSON.stringify(jsyaml.safeLoad(currentText), null, 2);
                state.currentFormat = "JSON";
                state.editor.setOption("mode", "javascript");
            }
            else {
                nextText = jsyaml.dump(JSON.parse(currentText));
                state.currentFormat = "YAML";
                state.editor.setOption("mode", "yaml");
            }
            state.editor.setValue(nextText);
        };

        initBlocks(Blockly);
        initCodegen(Blockly);
        initParseText(Blockly);
        init(Blockly);
    </script>
</body>

</html>